# 简化同步测试指南

## 🎯 测试目标
专注测试在线账号状态下的4个核心同步功能

## 📋 测试前准备

### 必需条件
- [x] 开发者权限账户（能看到测试面板）
- [x] 有效的在线账户（邮箱+密码）
- [x] 浏览器开发者工具已打开
- [x] 测试面板已启用

### 测试环境设置
1. **清理环境**: F12 → Application → 清空 Local Storage
2. **启动工具**: 刷新页面 → 登录在线账户 → 打开测试面板
3. **验证状态**: 确认显示在线用户邮箱，同步状态正常

---

## 🧪 核心测试用例

### TC-S01: 在线状态记录同步测试

**测试内容**: 本地做题后，已完成、未完成日志是否能正常同步到云端

#### 测试步骤:
1. **确认在线状态**
   - 用户显示在线邮箱
   - 网络状态正常

2. **完成题目测试**
   - 完成一套完整题目（5道题）
   - 观察测试面板中的同步日志
   - 检查控制台网络请求

3. **未完成题目测试**
   - 开始新题目但只做2-3道题
   - 直接刷新页面（模拟中断）
   - 观察未完成记录的同步情况

4. **验证同步结果**
   - 测试面板查看网络请求记录
   - 控制台查看同步成功日志

**预期结果**:
- ✅ 完成题目后立即触发同步网络请求
- ✅ 测试面板显示 `flush_start` → `flush_success` 日志
- ✅ 网络请求状态为 200，响应正常
- ✅ 未完成记录也能正常同步

**关键日志**:
```
[TEST-SYNC] enqueue_success - 记录入队成功
[TEST-SYNC] flush_start - 开始同步
[TEST-SYNC] flush_success - 同步完成
```

---

### TC-S02: 多设备数据同步测试

**测试内容**: 登录账号后，在别的设备产生的记录变更能不能正常同步过来

#### 测试步骤:
1. **设备A操作**
   - 在当前浏览器完成2-3道题
   - 等待同步完成

2. **模拟设备B**
   - 打开新的隐私窗口（或不同浏览器）
   - 登录相同的在线账户
   - 完成2-3道不同题目

3. **设备A验证**
   - 在原浏览器中手动点击"同步"按钮
   - 或者刷新页面重新登录
   - 检查历史记录是否包含设备B的记录

4. **数据验证**
   - 查看历史记录页面
   - 确认记录总数正确
   - 验证没有重复记录

**预期结果**:
- ✅ 设备A能看到设备B的记录
- ✅ 记录时间戳正确
- ✅ 分数和题目详情准确
- ✅ 无重复或丢失记录

**关键日志**:
```
[TEST-SYNC] 从服务端拉取到 X 条新记录
[TEST-SYNC] 合并服务端记录完成
```

---

### TC-S03: 离线状态同步测试

**测试内容**: 登录但处于离线状态时产生的日志能不能正常同步到云端

#### 测试步骤:
1. **确认在线登录状态**
   - 登录在线账户
   - 确认同步正常

2. **断开网络**
   - 开发者工具 → Network → Offline
   - 或直接断开Wi-Fi连接

3. **离线做题**
   - 完成2-3道题目
   - 观察测试面板离线日志
   - 确认记录进入离线队列

4. **恢复网络**
   - 重新连接网络
   - 观察自动同步过程
   - 检查队列是否清空

5. **验证结果**
   - 检查云端是否收到离线期间的记录
   - 确认队列状态为空

**预期结果**:
- ✅ 离线时记录保存到本地队列
- ✅ 联网后自动触发同步
- ✅ 离线记录成功上传到云端
- ✅ 同步完成后队列清空

**关键日志**:
```
[TEST-SYNC] flush_skip - 网络离线，跳过同步
[TEST-SYNC] enqueue_success - 离线记录入队
[TEST-SYNC] flush_start - 网络恢复，开始同步
[TEST-SYNC] 队列中 X 条记录等待同步
```

---

### TC-S04: 本机记录清除同步测试

**测试内容**: 测试者账号在清除本机记录时，是否能正常同步到云端

#### 测试步骤:
1. **准备测试数据**
   - 完成5-10道题目
   - 确认记录已同步到云端

2. **清除本机记录**
   - 进入开发者菜单 → "生成测试数据"
   - 点击"清空当前用户记录"按钮
   - 确认本地历史记录为空

3. **验证云端同步**
   - 重新登录相同账户
   - 检查是否能从云端恢复记录
   - 确认记录完整性

4. **再次清除测试**
   - 清除本机记录
   - 检查云端记录是否仍然存在

**预期结果**:
- ✅ 清除本机记录不影响云端数据
- ✅ 重新登录能恢复云端记录
- ✅ 数据完整性保持正确
- ✅ 本地清除操作不会误删云端数据

**关键日志**:
```
[TEST-STORAGE] remove - 清除本地记录
[TEST-SYNC] 从服务端拉取到历史记录
[TEST-SYNC] 恢复云端数据完成
```

---

## 📊 测试执行记录模板

### 基本信息
```
测试时间: [YYYY-MM-DD HH:MM:SS]
测试人员: [姓名]
浏览器: [Chrome/Firefox] [版本]
测试账户: [测试邮箱]
```

### TC-S01 结果
```
步骤1 - 确认在线状态: ✅通过 / ❌失败
步骤2 - 完成题目测试: ✅通过 / ❌失败  
步骤3 - 未完成题目测试: ✅通过 / ❌失败
步骤4 - 验证同步结果: ✅通过 / ❌失败

问题记录: [如有问题详细描述]
关键日志: [粘贴相关日志]
```

### TC-S02 结果
```
步骤1 - 设备A操作: ✅通过 / ❌失败
步骤2 - 模拟设备B: ✅通过 / ❌失败
步骤3 - 设备A验证: ✅通过 / ❌失败
步骤4 - 数据验证: ✅通过 / ❌失败

问题记录: [如有问题详细描述]
记录统计: 设备A [X]条, 设备B [X]条, 合计 [X]条
```

### TC-S03 结果
```
步骤1 - 确认在线登录: ✅通过 / ❌失败
步骤2 - 断开网络: ✅通过 / ❌失败
步骤3 - 离线做题: ✅通过 / ❌失败
步骤4 - 恢复网络: ✅通过 / ❌失败
步骤5 - 验证结果: ✅通过 / ❌失败

问题记录: [如有问题详细描述]
离线记录数: [X]条
队列状态: [最终是否清空]
```

### TC-S04 结果
```
步骤1 - 准备测试数据: ✅通过 / ❌失败
步骤2 - 清除本机记录: ✅通过 / ❌失败
步骤3 - 验证云端同步: ✅通过 / ❌失败
步骤4 - 再次清除测试: ✅通过 / ❌失败

问题记录: [如有问题详细描述]
恢复记录数: [X]条
数据完整性: ✅正确 / ❌有误
```

---

## 🚨 常见问题检查

### 同步失败
1. 检查网络连接状态
2. 确认用户登录状态
3. 查看控制台错误信息
4. 检查测试面板错误日志

### 数据丢失
1. 检查本地存储内容
2. 确认云端数据状态
3. 验证同步队列状态
4. 查看冲突处理日志

### 记录重复
1. 检查 client_id 冲突日志
2. 验证去重机制
3. 确认时间戳正确性

---

## 📁 测试数据收集

完成测试后，请收集以下信息：

1. **测试面板导出**: 点击"导出"按钮保存 JSON 文件
2. **控制台日志**: 全选复制 Console 内容
3. **网络请求**: 截图或保存关键的 Supabase API 请求
4. **问题截图**: 如有异常现象进行截图

**文件命名格式**: 
- `test-logs-sync-[YYYYMMDD-HHMMSS].json`
- `console-logs-sync-[YYYYMMDD-HHMMSS].txt`
- `network-requests-sync-[YYYYMMDD-HHMMSS].png`
