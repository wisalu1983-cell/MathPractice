# 用户数据同步功能测试指南

## 📋 测试环境准备

### 前置条件
- [x] 确保 Supabase 连接正常
- [x] 确保有可用的在线账户（邮箱+密码）
- [x] 浏览器开发者工具已打开（Console、Network 标签页）
- [x] 测试辅助面板已启用（见测试日志输出部分）

### 测试数据准备
- [x] 准备至少 2-3 个本地用户账户
- [x] 准备 1-2 个在线账户（不同邮箱）
- [x] 确保有一些历史记录数据用于同步测试

---

## 🧪 核心测试用例

### TC001: 用户身份切换与数据隔离测试

**目标**: 验证不同用户类型之间的数据隔离和切换逻辑

#### TC001-1: Guest 用户隔离测试
**步骤**:
1. 清空所有本地存储数据
2. 刷新页面，确认处于 Guest 状态
3. 完成 2-3 道题目
4. 检查是否有同步相关的网络请求
5. 检查本地存储中是否保存了记录

**预期结果**:
- ✅ 用户显示为 "Guest"
- ✅ 无任何同步网络请求
- ✅ 本地存储中无历史记录保存
- ✅ 无法访问历史记录页面

---

#### TC001-2: Guest → Local 用户切换测试
**步骤**:
1. 从 Guest 状态创建本地用户 "TestLocal1"
2. 完成 2-3 道题目
3. 检查历史记录保存情况
4. 检查同步状态

**预期结果**:
- ✅ 用户显示为 "TestLocal1"
- ✅ 历史记录正常保存到本地存储
- ✅ 无同步网络请求
- ✅ 可以查看历史记录

---

#### TC001-3: Local → Online 用户切换测试
**步骤**:
1. 从本地用户状态登录在线账户
2. 观察同步过程和日志
3. 检查服务端数据
4. 完成新题目，验证自动同步

**预期结果**:
- ✅ 登录成功，用户显示在线邮箱
- ✅ 触发自动同步，上传本地数据
- ✅ 新完成题目自动同步到服务端
- ✅ 历史记录显示合并后的数据

---

### TC002: 数据同步功能测试

#### TC002-1: 首次登录数据上传测试
**步骤**:
1. 创建本地用户，完成 5-10 道题目
2. 记录题目详情和分数
3. 登录在线账户
4. 等待同步完成
5. 在 Supabase 后台验证数据

**预期结果**:
- ✅ 所有本地记录成功上传
- ✅ 服务端数据与本地数据一致
- ✅ client_id 字段正确设置
- ✅ 同步状态显示成功

---

#### TC002-2: 数据下载与合并测试
**步骤**:
1. 在设备A登录账户，完成题目A
2. 在设备B登录同一账户
3. 设备B完成题目B
4. 设备A刷新或重新登录
5. 检查数据合并情况

**预期结果**:
- ✅ 设备A显示题目A和B的记录
- ✅ 设备B显示题目A和B的记录
- ✅ 无重复记录
- ✅ 时间戳和分数正确

---

#### TC002-3: 数据冲突处理测试
**步骤**:
1. 设备A离线完成题目，生成记录ID1
2. 设备B同时离线完成题目，生成相同ID1
3. 设备A先联网同步
4. 设备B后联网同步
5. 检查冲突处理结果

**预期结果**:
- ✅ 两条记录都成功保存
- ✅ 冲突记录生成唯一别名ID
- ✅ 无数据丢失
- ✅ 冲突处理日志清晰

---

### TC003: 网络状态与离线功能测试

#### TC003-1: 离线队列功能测试
**步骤**:
1. 登录在线账户
2. 断开网络连接
3. 完成 3-5 道题目
4. 检查离线队列状态
5. 恢复网络连接
6. 观察自动同步过程

**预期结果**:
- ✅ 离线时数据保存到本地队列
- ✅ 联网后自动触发同步
- ✅ 队列中的记录依次上传
- ✅ 同步完成后队列清空

---

#### TC003-2: 网络不稳定测试
**步骤**:
1. 使用浏览器开发者工具模拟慢网络
2. 完成题目触发同步
3. 在同步过程中暂停网络
4. 恢复网络
5. 观察重试机制

**预期结果**:
- ✅ 网络中断时显示同步失败
- ✅ 网络恢复后自动重试
- ✅ 重试次数符合配置
- ✅ 最终同步成功

---

### TC004: 错误处理与恢复测试

#### TC004-1: 同步超时测试
**步骤**:
1. 使用网络限流工具模拟极慢网络
2. 完成题目触发同步
3. 等待超时发生（30秒）
4. 检查错误处理和状态恢复

**预期结果**:
- ✅ 30秒后触发超时错误
- ✅ 同步状态正确重置
- ✅ 错误信息记录到日志
- ✅ 后续同步不受影响

---

#### TC004-2: 服务端错误测试
**步骤**:
1. 暂时关闭 Supabase 连接或使用错误的 URL
2. 完成题目触发同步
3. 检查错误处理
4. 恢复正确配置
5. 验证错误恢复

**预期结果**:
- ✅ 显示连接错误信息
- ✅ 数据保留在离线队列
- ✅ 连接恢复后自动重试
- ✅ 最终同步成功

---

### TC005: 边界条件与性能测试

#### TC005-1: 大量数据同步测试
**步骤**:
1. 使用测试数据生成器创建大量记录（50+）
2. 登录在线账户触发同步
3. 观察同步性能和稳定性
4. 检查内存使用情况

**预期结果**:
- ✅ 大量数据成功同步
- ✅ 同步过程相对流畅
- ✅ 无内存泄漏或崩溃
- ✅ 最终数据完整性正确

---

#### TC005-2: 并发同步测试
**步骤**:
1. 快速连续完成多道题目
2. 在同步进行中继续完成题目
3. 观察队列处理和并发控制
4. 验证最终数据一致性

**预期结果**:
- ✅ 并发请求正确排队
- ✅ 无重复提交或数据丢失
- ✅ 同步状态显示正确
- ✅ 所有记录最终同步成功

---

## 🐛 已知问题回归测试

### RC001: 数据一致性问题修复验证
**测试目标**: 验证 client_id 冲突处理修复效果

**步骤**:
1. 创建 client_id 冲突场景
2. 验证保守策略是否生效
3. 检查是否有数据丢失

**预期结果**:
- ✅ 冲突数据生成唯一别名ID
- ✅ 无数据覆盖或丢失
- ✅ 冲突处理日志清晰

---

### RC002: 同步状态管理修复验证
**测试目标**: 验证超时机制和状态恢复修复效果

**步骤**:
1. 触发超时场景
2. 验证状态是否正确重置
3. 检查后续同步是否正常

**预期结果**:
- ✅ 超时后状态正确重置
- ✅ 无永久挂起情况
- ✅ 后续同步正常进行

---

## 📊 测试结果记录模板

### 测试用例执行记录
```
测试用例ID: TC001-1
测试时间: 2025-08-15 14:30:00
测试人员: [测试人员名称]
测试环境: Chrome 最新版 / Windows 11

执行步骤:
1. [实际执行步骤1] - ✅通过 / ❌失败
2. [实际执行步骤2] - ✅通过 / ❌失败
...

实际结果:
- [详细描述实际观察到的结果]

问题记录:
- [如有问题，详细描述问题现象]
- [附加相关的日志、截图或错误信息]

测试结论: ✅通过 / ❌失败 / ⚠️部分通过
```

---

## 🔄 测试流程建议

### 每日测试流程
1. **环境检查** (5分钟)
   - 验证测试环境状态
   - 检查测试数据准备情况

2. **冒烟测试** (10分钟)
   - 执行 TC001-1, TC002-1, TC003-1
   - 确保基本功能正常

3. **功能测试** (30分钟)
   - 按优先级执行测试用例
   - 记录测试结果和问题

4. **回归测试** (15分钟)
   - 执行已知问题回归测试
   - 验证修复效果

5. **结果整理** (10分钟)
   - 整理测试日志和结果
   - 更新问题跟踪状态

### 测试优先级
- **P0 (最高)**: TC001-*, TC002-1, TC003-1
- **P1 (高)**: TC002-2~3, TC003-2, TC004-*
- **P2 (中)**: TC005-*, RC001~002
- **P3 (低)**: 性能测试和边界条件测试

---

## 📝 测试检查清单

### 测试前检查
- [ ] 测试环境已准备就绪
- [ ] 开发者工具已打开
- [ ] 测试日志系统已启用
- [ ] 测试数据已清理/准备

### 测试中检查
- [ ] 每个步骤都记录了实际结果
- [ ] 相关日志已保存
- [ ] 网络请求已记录
- [ ] 异常情况已截图

### 测试后检查
- [ ] 测试结果已记录
- [ ] 问题已分类和优先级排序
- [ ] 日志已导出和归档
- [ ] 测试环境已清理
